<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الألغاز والأحاجي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1.700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Amiri', serif;
            background: linear-gradient(135deg, #0f172a 0%, #302b63 100%);
            overflow: hidden;
        }
        /* إخفاء المحتوى الرئيسي أثناء التحميل */
        body.is-loading .game-card {
            opacity: 0;
        }
        
        h1, h2, h3, h4, p, span, div, button, input {
            font-family: 'Amiri', serif;
            font-size: 1.1rem;
        }
        h1 { font-size: 2.75rem !important; font-weight: 700; }
        .puzzle-question { font-size: 1.75rem !important; font-weight: 700; line-height: 1.6; }
        .puzzle-rule { font-size: 1rem !important; }
        .choice-label { font-size: 1.1rem !important; font-weight: 700; }
        .game-button { font-size: 1.2rem !important; font-weight: 700; }
        .back-button { font-size: 1rem !important; }
        .stat-item span { font-size: 0.85rem !important; font-weight: 400; }
        .stat-item strong { font-size: 1.35rem !important; font-weight: 700; }

        .game-card {
            background: rgba(17, 25, 40, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.125);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 95vh;
            overflow-y: auto;
            transition: opacity 0.3s ease-in-out;
        }
        
        /* تصميم شريط التمرير للنافذة المنبثقة */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
            border: 2px solid rgba(30, 41, 59, 0.95);
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 1.5rem;
        }
        .stat-item { text-align: center; color: #d1d5db; }
        .stat-item span { display: block; color: #9ca3af; text-transform: uppercase; }
        .stat-item strong { display: block; color: #f3f4f6; min-width: 40px; }
        #stat-highscore strong { color: #facc15; }
        #stat-streak strong { color: #38bdf8; }

        .choice-label {
            display: block;
            padding: 12px 20px;
            background-color: rgba(30, 41, 59, 0.8);
            border: 1px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #d1d5db;
            text-align: center;
        }
        .choice-label:hover {
            background-color: rgba(55, 65, 81, 0.8);
            border-color: #4b5563;
        }
        input[type='radio'] { display: none; }
        input[type='radio']:checked + .choice-label {
            background-color: #0c4a6e;
            border-color: #0ea5e9;
            color: #e0f2fe;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        .game-input {
            background-color: rgba(30, 41, 59, 0.8);
            border: 1px solid #374151;
            color: #f3f4f6;
            transition: all 0.2s ease-in-out;
            font-size: 1.25rem;
        }
        .game-input::placeholder { color: #6b7280; }
        .game-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
            background-color: rgba(30, 41, 59, 1);
        }
        .game-input-correct {
            border-color: #10b981 !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5) !important;
        }
        .game-input-wrong {
            border-color: #ef4444 !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5) !important;
        }

        .game-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .game-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .game-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .game-button-blue { background: linear-gradient(45deg, #0ea5e9, #0c4a6e); }
        .game-button-blue:hover:not(:disabled) { background: linear-gradient(45deg, #38bdf8, #075985); }
        .game-button-green { background: linear-gradient(45deg, #10b981, #057a55); }
        .game-button-green:hover:not(:disabled) { background: linear-gradient(45deg, #34d399, #046c4e); }
        .game-button-yellow { background: linear-gradient(45deg, #f59e0b, #b45309); }
        .game-button-yellow:hover:not(:disabled) { background: linear-gradient(45deg, #facc15, #d97706); }
        .game-button-gray { background: linear-gradient(45deg, #4b5563, #1f2937); }
        .game-button-gray:hover:not(:disabled) { background: linear-gradient(45deg, #6b7280, #374151); }
        .game-button-red { background: linear-gradient(45deg, #991b1b, #7f1d1d); }
        .game-button-red:hover:not(:disabled) { background: linear-gradient(45deg, #b91c1c, #991b1b); }

        .back-button {
            color: #94a3b8;
            text-align: center;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .back-button:hover { color: #e2e8f0; }

        .puzzle-screen {
            background: rgba(17, 25, 40, 0.9);
            border: 1px solid #374151;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
            transition: opacity 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        #feedback-message {
            transition: all 0.3s ease;
            text-shadow: 0 0 10px;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .feedback-correct { color: #34d399; text-shadow: 0 0 10px rgba(52, 211, 153, 0.7); }
        .feedback-wrong { color: #f87171; text-shadow: 0 0 10px rgba(248, 113, 113, 0.7); }
        .feedback-info { color: #60a5fa; text-shadow: 0 0 10px rgba(96, 165, 250, 0.7); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
        .animate-shake { animation: shake 0.5s ease-in-out; }

        .screen {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            width: 100%;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            left: -9999px;
        }
        .card-wrapper {
            position: relative;
            min-height: 550px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #e0f2fe;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-content h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #4b5563;
            padding-bottom: 0.25rem;
        }
        .modal-content p {
            font-size: 1.1rem;
            color: #d1d5db;
            margin-bottom: 0.75rem;
            line-height: 1.8;
        }
        .modal-content p strong {
            color: #f3f4f6;
            font-weight: 700;
        }
        .modal-content ul {
            list-style-type: decimal;
            margin-right: 1.5rem;
            color: #d1d5db;
        }
        .modal-content li {
            margin-bottom: 0.5rem;
            line-height: 1.8;
        }
        .color-f1 { color: #60a5fa; }
        .color-f2 { color: #34d399; }
        .color-f3 { color: #fde047; }
        .color-f4 { color: #f87171; }
        .color-f5 { color: #c084fc; }
        .color-f6 { color: #9ca3af; }

        /* شاشة التحميل */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #302b63 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #e0f2fe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: #e0f2fe;
            margin-top: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* زر كتم الصوت والتلميح */
        #mute-button {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #374151;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #9ca3af;
            transition: all 0.2s ease;
        }
        #mute-button:hover {
            color: #e0f2fe;
            background: rgba(55, 65, 81, 0.8);
            border-color: #4b5563;
        }
        #mute-button svg {
            width: 20px;
            height: 20px;
        }
        #mute-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: 1.5rem;
            left: 4.5rem;
            background: #1e293b;
            color: #e0f2fe;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #mute-button:hover + #mute-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .icon-off { display: none; }
        
        /* زر مشاركة النتيجة */
        #last-score-container {
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        #last-score-text {
            color: #d1d5db;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }
        #share-button {
            font-size: 1rem !important;
            padding: 0.5rem 1rem;
            background: linear-gradient(45deg, #10b981, #057a55);
        }
        #share-feedback {
            color: #34d399;
            font-size: 0.9rem;
            height: 1rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="is-loading flex items-center justify-center min-h-screen p-4">

    <!-- شاشة التحميل -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <p class="loading-text">جارٍ تحميل نظام الألغاز...</p>
    </div>

    <div class="game-card rounded-xl p-6 md:p-8 w-full max-w-lg m-4 relative">
        
        <!-- زر كتم الصوت -->
        <button id="mute-button">
            <svg class="icon-on" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.718-.54-1.99-1.354a9.009 9.009 0 0 1-.3-1.003V12c0-.362.068-.71.187-1.046.12-.336.31-.643.553-.89l.262-.262c.243-.247.553-.437.89-.553.336-.12.684-.187 1.046-.187h2.24Z" /></svg>
            <svg class="icon-off" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.718-.54-1.99-1.354a9.009 9.009 0 0 1-.3-1.003V12c0-.362.068-.71.187-1.046.12-.336.31-.643.553-.89l.262-.262c.243-.247.553-.437.89-.553.336-.12.684-.187 1.046-.187h2.24Z" /></svg>
        </button>
        <div id="mute-tooltip">كتم الصوت</div>


        <h1 class="text-3xl md:text-4xl text-center text-white mb-2">
            نظام الألغاز
        </h1>
        <!-- (إصلاح 3) تمت إضافة عنوان فرعي -->
        <p class="text-center text-blue-300 mb-8 text-sm font-medium" style="font-size: 1.1rem !important;">
            اختبر معرفتك بالأحاجي العربية
        </p>

        <div class="card-wrapper">

            <!-- منطقة الاختيار (شاشة 1) -->
            <div id="selection-container" class="screen space-y-6">

                <!-- قسم مشاركة النتيجة -->
                <div id="last-score-container" class="hidden">
                    <p id="last-score-text">كانت نتيجتك الأخيرة: 100</p>
                    <button id="share-button" class="w-full text-white p-2 rounded-lg text-lg game-button">
                        مشاركة النتيجة
                    </button>
                    <div id="share-feedback"></div>
                </div>

                <fieldset>
                    <legend class="px-2 mb-3 font-semibold text-lg text-gray-200" style="font-size: 1.3rem !important;">اختر المستوى:</legend>
                    <div class="grid grid-cols-3 gap-3">
                        <label>
                            <input type="radio" name="difficulty" value="سهل" checked onchange="playSound('click')">
                            <span class="choice-label">سهل</span>
                        </label>
                        <label>
                            <input type="radio" name="difficulty" value="متوسط" onchange="playSound('click')">
                            <span class="choice-label">متوسط</span>
                        </label>
                        <label>
                            <input type="radio" name="difficulty" value="صعب" onchange="playSound('click')">
                            <span class="choice-label">صعب</span>
                        </label>
                    </div>
                </fieldset>

                <div class="grid grid-cols-2 gap-4 pt-4">
                     <button id="how-to-play-button" class="w-full text-white p-4 rounded-lg text-lg game-button game-button-gray">
                        كيفية اللعب؟
                    </button>
                    <button id="start-button" class="w-full text-white p-4 rounded-lg text-lg game-button game-button-blue">
                        ابدأ اللعب
                    </button>
                </div>
                
                <!-- زر مسح الرصيد -->
                <button id="reset-highscore-button" class="w-full text-white p-3 rounded-lg text-sm game-button game-button-red opacity-70" style="font-size: 1rem !important;">
                    مسح أعلى رصيد
                </button>

            </div>

            <!-- منطقة اللغز والإدخال (شاشة 2) -->
            <div id="puzzle-container" class="screen hidden space-y-5">
                
                <div class="stats-bar">
                    <div id="stat-score" class="stat-item">
                        <span>النقاط</span>
                        <strong>0</strong>
                    </div>
                    <div id="stat-highscore" class="stat-item">
                        <span>أعلى رصيد</span>
                        <strong>0</strong>
                    </div>
                    <div id="stat-streak" class="stat-item">
                        <span>الستريك</span>
                        <strong>0</strong>
                    </div>
                </div>

                <div id="puzzle-screen-content" class="puzzle-screen p-6 rounded-lg text-right min-h-[150px] flex flex-col justify-center">
                    <p id="puzzle-rule" class="puzzle-rule mb-3 hidden"></p>
                    <p id="puzzle-question" class="puzzle-question text-white"></p>
                </div>

                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="answer-input" 
                        placeholder="اكتب إجابتك هنا..."
                        class="w-full p-4 border rounded-lg text-right text-lg game-input"
                    >
                    <div class="grid grid-cols-2 gap-4">
                        <button id="check-button" class="w-full text-white p-4 rounded-lg text-lg game-button game-button-green">
                            تحقق من الإجابة
                        </button>
                        <button id="show-answer-button" class="w-full text-white p-4 rounded-lg text-lg game-button game-button-yellow">
                            معرفة الجواب
                        </button>
                    </div>
                </div>

                <div id="feedback-message" class="mt-4 text-center h-8"></div>
                
                <button id="back-to-settings-button" class="back-button w-full mt-4">
                    العودة للإعدادات
                </button>
            </div>
        </div>

        <p class="text-center text-xs text-gray-500 mt-6" style="font-size: 0.8rem !important;">
            الإصدار 1.1 (نسخة مُصححة)
        </p>
    </div>

    <!-- نافذة كيفية اللعب (المحتوى الكامل) -->
    <div id="how-to-play-modal" class="modal-overlay">
        <div class="modal-content" dir="rtl">
            <h3>نظام الألغاز والإحاجي</h3>
            
            <h4 class="color-f1">الفصل الأول: قواعد عامة</h4>
            <p><strong>المادة الأولى:</strong> يُلغز بالاسم فقط دون الفعل أو اسم الفعل أو الفاعل أو المفعول أو صيغ المبالغة والتعجب والتفضيل أو أسماء الزمان أو المكان وما أشبه ذلك مما لا يدلّ على معنى معين قائم بذاته.</p>
            <p><strong>المادة الثانية:</strong> الاسم الذي يُلغّز به يعمّ العلم الشخصي أو أسماء الأشياء أو النبات أو الحيوان أو الصفات أو غيرها.</p>
            <p><strong>المادة الثالثة:</strong> يجب أن لا يكون الاسم الملغز فيه:</p>
            <ul>
                <li>١- من لغة أعجمية كله أو جزؤه.</li>
                <li>٢- ألا يكون مركباً من ضمير، أو الألف واللام أو ياء النسبة أو غيرها.</li>
            </ul>
            <p><strong>المادة الرابعة:</strong> يجب أن يحرر الملغز عن اللغز واضح ومعلوم لدى أكثر الملمين إليهم.</p>
            <p><strong>المادة الخامسة:</strong> العبارة التي يعبر بها عن اللغز يجوز أن تكون كلمة أو جملة أو بعض جملة أو مضافة إلى ضمير وغير ذلك.</p>
            <p><strong>المادة السادسة:</strong> أي اسم جاء حالة موافقاً للشروط التي اعتبرت في اللغز فهو مقبول وإن لم يكن نفس الاسم المنوي.</p>
            <p><strong>المادة السابعة:</strong> إذا جاء الحل بما يخالف المادة الأولى أو الثالثة يرفض.</p>

            <h4 class="color-f2">الفصل الثاني: الملفق</h4>
            <p><strong>المادة الثامنة:</strong> كيفية اللغز الملفق: هو تبديل مكان الحروف بحيث ينتج منه كلمة أو عدة كلمات ذات معنى.</p>
            <p><strong>المادة التاسعة:</strong> يجوز أن يكون اللغز أكثر من كلمة واحدة.</p>
            <p><strong>المادة العاشرة:</strong> يجب أن تكون الكلمة أو عدة الكلمات التي يُعبّر بها عن اللغز ذات معنى مفهوم لغةً.</p>
            <p><strong>المادة الحادية عشرة:</strong> ليست الحركات محل اعتبار في اللغز الملفق.</p>
            <p><strong>المادة الثانية عشرة:</strong> يجب ألا يكون في صيغة اللغز حروف زائدة أو ناقصة فتحدث التشويش والارتباك.</p>

            <h4 class="color-f3">الفصل الثالث: للأحجية</h4>
            <p><strong>المادة الثالثة عشرة:</strong> الأحجية هي تقطيع الكلمة إلى مقطع أو أكثر بحيث ينتج من كل مقطع معه معنى تام بذاته، كل مقطع بانفراده.</p>
            <p><strong>المادة الرابعة عشرة:</strong> يجب أن يكون بين المقطعين علاقة عامة إما الإضافة أو الوصفية أو الخبرية وما أشبه.</p>
            <p><strong>المادة الخامسة عشرة:</strong> يجب ألا يحصل تكرار في الحروف في ضمن تقطيع الاسم إلى مقطعين أو أكثر.</p>
            <p><strong>المادة السادسة عشرة:</strong> يجوز أن يعرف المقطع الواحد بكلمة واحدة أو عدة كلمات.</p>
            <p><strong>المادة السابعة عشرة:</strong> يجب أن تكون الكلمة أو الكلمات التي يعرّف بواسطتها اللغز لا غامضة بحيث يعسر فهمها ولا واضحة بحيث يسهل حلها.</p>

            <h4 class="color-f4">الفصل الرابع: اللغز</h4>
            <p><strong>المادة الثامنة عشرة:</strong> لا اسم لهذا اللغز فلذا اعتبرناه (لغزاً) بالمعنى الأعم.</p>
            <p><strong>المادة التاسعة عشرة:</strong> كيفية اللغز بالمعنى الأعم: هي جمع حرفين فأكثر، سواء كانا متلاصقين في أصل الكلمة أو منفصلين أم متقدمين أو متأخرين، بحيث يحصل بجمعها معنى معين، ثم يأتي الملغز بكلمة ترادفه أو تدل عليه.</p>
            <p><strong>المادة العشرون:</strong> يجب تعيين ما يلي في كل اسم ملغز:</p>
            <ul>
                <li>١- عدد حروفه.</li>
                <li>٢- أنه إسم لأي صنف من الأشياء.</li>
                <li>٣- أنه هل يحتوي أو لا يحتوي على الألف بحساب (أبجد).</li>
            </ul>
            <p><strong>المادة الحادية والعشرون:</strong> يجب استيفاء جميع حروف الاسم على التبادل بينها.</p>
            <p><strong>المادة الثانية والعشرون:</strong> يجوز أن تتكرر حروف الاسم في أي مقطع من المقاطع، ولا يجوز تكرار الحرف الواحد في المقطع الواحد أكثر من مرة واحدة.</p>
            <p><strong>المادة الثالثة والعشرون:</strong> يجب تعيين المكان العددي للحرف من بين مجموع الحروف.</p>
            <p><strong>المادة الرابعة والعشرون:</strong> يشترك كل من الأحجية واللغز بالمعنى الأخص بأن العبارة التي يعرف بها الاسم أو الحرف يجب أن تكون مفهومة لغةً وعرفاً.</p>

            <h4 class="color-f5">الفصل الخامس: المعمّى</h4>
            <p><strong>المادة الخامسة والعشرون:</strong> المعمّى: هو اللغز الذي استعملت فيه مرحلتان أو أكثر في طريق حلّه.</p>
            <p><strong>المادة السادسة والعشرون:</strong> لا يجب أن تكون عبارة المعمّى واضحة، بل فقط يجب كونها ذات مدلول لغوي تام.</p>
            <p><strong>المادة السابعة والعشرون:</strong> يجوز أن يكون كل من المرحلتين أو الأكثر لغزاً مما سبق في الفصول الثلاثة السابقة، أو يكون شيئاً آخر كحساب أبجد -مثلاً-.</p>

            <h4 class="color-f6">الفصل السادس: تتمة</h4>
            <p><strong>المادة الثامنة والعشرون:</strong> كل ما لم يُذكر في هذا النظام فهو جائز.</p>
            <p><strong>المادة التاسعة والعشرون:</strong> هذا النظام مختص باللغز اللغة العربية.</p>
            <p><strong>المادة الثلاثون:</strong> يجب على كل فرد عند استعمال الألغاز أن يتبع هذا النظام بمجرد علمه به، حالاً.</p>

            <button id="close-modal-button" class="w-full text-white p-3 rounded-lg text-lg game-button game-button-blue mt-6">
                فهمت! (إغلاق)
            </button>
        </div>
    </div>


    <script>
        // --- [المنطق المطور بالكامل] ---
        
        let isMuted = false;
        
        // 1. إعدادات الصوت
        const synths = {
            click: new Tone.MembraneSynth().toDestination(),
            start: new Tone.PluckSynth().toDestination(),
            correct: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
            }).toDestination(),
            wrong: new Tone.MonoSynth({
                oscillator: { type: "square" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0, release: 0.1 }
            }).toDestination(),
            info: new Tone.PluckSynth().toDestination(),
        };
        async function playSound(soundName) {
            if (isMuted && soundName !== 'force-click') return; 
            
            try {
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }
                if (soundName === 'correct') {
                    synths.correct.triggerAttackRelease(["C4", "E4", "G4"], 0.2);
                } else if (soundName === 'wrong') {
                    synths.wrong.triggerAttackRelease("E3", "0.25");
                } else if (soundName === 'start') {
                    synths.start.triggerAttackRelease("C4", 0.5);
                } else if (soundName === 'info') {
                    synths.info.triggerAttackRelease("G4", 0.5);
                } else if (soundName === 'click' || soundName === 'force-click') {
                    synths.click.triggerAttackRelease("C2", "8n");
                }
            } catch (e) {
                console.error("Audio playback error:", e);
            }
        }

        // دالة التطبيع الذكي
        function normalizeArabic(str) {
            if (!str) return "";
            return str.trim()
                .replace(/[\u064B-\u0652]/g, '') // إزالة التشكيل (الحركات)
                .replace(/[أإآ]/g, 'ا')         // توحيد الهمزات على الألف
                .replace(/ى/g, 'ي')             // توحيد الألف المقصورة
                .replace(/ة/g, 'ه');            // توحيد التاء المربوطة
        }

        // 2. قاعدة المعرفة الموسعة (*** تم تصحيح الأخطاء هنا ***)
        const knowledgeBase = [
            // --- القسم الأول: الألغاز المُلفّقة (20) ---
            { type: "ملفق", difficulty: "سهل", question_text: "سائل للكتابة، إذا لفّقت حروفه صار: ماءً عظيماً.", answer: ["بحر", "حبر"] },
            { type: "ملفق", difficulty: "سهل", question_text: "حيوان للركوب، إذا لفّقت حروفه صار: ارتحالاً.", answer: ["سفر", "فرس"] },
            { type: "ملفق", difficulty: "سهل", question_text: "عضو ينبض، إذا لفّقت حروفه صار: اسم العائلة.", answer: ["لقب", "قلب"] },
            { type: "ملفق", difficulty: "سهل", question_text: "طعام مالح، إذا لفّقت حروفه صار: ما يراه النائم.", answer: ["حلم", "ملح"] },
            { type: "ملفق", difficulty: "سهل", question_text: "رجاء للمستقبل، إذا لفّقت حروفه صار: وجعاً.", answer: ["أمل", "ألم"] },
            { type: "ملفق", difficulty: "سهل", question_text: "ثمر النخيل، إذا لفّقت حروفه صار: أداة للربط.", answer: ["حبل", "بلح"] },
            { type: "ملفق", difficulty: "سهل", question_text: "كلام مقفى، إذا لفّقت حروفه صار: مقعد الملك.", answer: ["عرش", "شعر"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "كوكب ليلي، إذا لفّقت حروفه صار: عدداً حسابياً.", answer: ["رقم", "قمر"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "سلاح قديم، إذا لفّقت حروفه صار: مكاناً مقدساً.", answer: ["حرم", "رمح"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "طعام يومي، إذا لفّقت حروفه صار: صغير الشاة.", answer: ["حمل", "لحم"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "حيوان صبور، إذا لفّقت حروفه صار: ممنوعاً.", answer: ["حرام", "حمار"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "أداة رمي، إذا لفّقت حروفه صار: صوتاً خافتاً.", answer: ["همس", "سهم"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "ذكر الضأن، إذا لفّقت حروفه صار: أداة للصيد.", answer: ["شبك", "كبش"] },
            { type: "ملفق", difficulty: "متوسط", question_text: "فاكهة، إذا لفّقت حروفه صار: عين الماء.", answer: ["نبع", "عنب"] },
            { type: "ملفق", difficulty: "صعب", question_text: "طيب وعطر، إذا لفّقت حروفه صار: حيواناً بحرياً.", answer: ["سمك", "مسك"] },
            { type: "ملفق", difficulty: "صعب", question_text: "شريك الحياة، إذا لفّقت حروفه صار: مكسرات.", answer: ["جوز", "زوج"] },
            { type: "ملفق", difficulty: "صعب", question_text: "فصل الجمال، إذا لفّقت حروفه صار: شذىً وعطراً.", answer: ["عبير", "ربيع"] },
            { type: "ملفق", difficulty: "صعب", question_text: "حيوانات، إذا لفّقت حروفه صار: دنوّاً.", answer: ["قرب", "بقر"] },
            { type: "ملفق", difficulty: "صعب", question_text: "عضو البصر، إذا لفّقت حروفه صار: إخباراً بالموت.", answer: ["نعي", "عين"] },
            { type: "ملفق", difficulty: "صعب", question_text: "دولة عربية، إذا لفّقت حروفه صار: عكس 'حلو'.", answer: ["مصر", "مر"] },

            // --- القسم الثاني: الأحاجي (20) ---
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم عملة، شطرها الأول (ملة ومعتقد)، وشطره الثاني (فعل أمر بالرؤية)؟", answer: ["دينار"] }, // (دين + ار)
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم طائر، شطره الأول (فعل أمر بالخداع)، وشطره الثاني (والد)؟", answer: ["غراب"] }, // (غر + اب)
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم زهرة، شطرها الأول (قنوط)، وشطره الثاني (من؟ بالعامية)؟", answer: ["ياسمين"] }, // (ياس + مين)
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم لقب، شطره الأول (هرب)، وشطره الثاني (مساعدة)؟", answer: ["فرعون"] }, // (فر + عون)
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم فاكهة، شطرها الأول (ارتحال)، وشطره الثاني (عَظُمَ قدره)؟", answer: ["سفرجل"] }, // (سفر + جل)
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم شيء بالبيت، شطره الأول (عكس خير)، وشطره الثاني (مضى)؟", answer: ["شرفات"] }, // (شر + فات)
            { type: "أحجية", difficulty: "سهل", question_text: "ما اسم بلدة، شطرها الأول (نقود تافهة)، وشطره الثاني (مادة الخلق)؟", answer: ["فلسطين"] }, // (فلس + طين)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم وسيلة تواصل، شطرها الأول (اليابسة)، وشطره الثاني (عضو بالجسم)؟", answer: ["بريد"] }, // (بر + يد)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم سائل سماوي، شطره الأول (قاتل)، وشطره الثاني (سائل الحياة)؟", answer: ["سماء"] }, // (سم + ماء)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم حجر كريم، شطره الأول (فعل أمر بالشد)، وشطره الثاني (جواب)؟", answer: ["زمرد"] }, // (زم + رد)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم طائر، شطره الأول (أمر بالمعصية)، وشطره الثاني (حالاً)؟", answer: ["عصفور"] }, // (عص + فور)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم نبات، شطره الأول (استقر)، وشطره الثاني (نافلة)؟", answer: ["قرنفل"] }, // (قر + نفل)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم عين بالجنة، شطرها الأول (فعل أمر بالسؤال)، وشطره الثاني (طريق)؟", answer: ["سلسبيل"] }, // (سل + سبيل)
            { type: "أحجية", difficulty: "متوسط", question_text: "ما اسم مكان، شطره الأول (أخ بالعامية)، وشطره الثاني (يابسة)؟", answer: ["خيبر"] }, // (خي + بر)
            { type: "أحجية", difficulty: "صعب", question_text: "ما اسم شعور، شطره الأول (شيء يكتم)، وشطره الثاني (خلف)؟", answer: ["سرور"] }, // (سر + ور[اء])
            { type: "أحجية", difficulty: "صعب", question_text: "ما اسم فاكهة، شطرها الأول (فعل أمر بالمشي)، وشطره الثاني (فعل أمر بالمشي)؟", answer: ["مشمش"] }, // (مش + مش)
            { type: "أحجية", difficulty: "صعب", question_text: "ما اسم سلطان، شطره الأول (استل)، وشطره الثاني (صوت الرنين)؟", answer: ["سلطان"] }, // (سل + طان)
            { type: "أحجية", difficulty: "صعب", question_text: "ما اسم شيء لابد منه، شطره الأول (أداة نفي)، وشطره الثاني (مفر)؟", answer: ["لابد"] }, // (لا + بد)
            { type: "أحجية", difficulty: "صعب", question_text: "ما اسم فاكهة، شطرها الأول (يابسة)، وشطره الثاني (يُقال)؟", answer: ["برتقال"] }, // (بر + تقال)
            { type: "أحجية", difficulty: "صعب", question_text: "ما اسم حبوب، شطره الأول (سم)، وشطره الثاني (سم)؟", answer: ["سمسم"] }, // (سم + سم)

            // --- القسم الثالث: اللغز - بالمعنى الأخص (20) ---
            { type: "لغز", difficulty: "سهل", question_text: "أداة للكتابة (3 حروف، جماد، لا يوجد ألف).", answer: ["قلم"] },
            { type: "لغز", difficulty: "سهل", question_text: "وعاء للمعرفة (4 حروف، جماد، يوجد ألف).", answer: ["كتاب"] },
            { type: "لغز", difficulty: "سهل", question_text: "نجم نهاري (3 حروف، كوكب، لا يوجد ألف).", answer: ["شمس"] },
            { type: "لغز", difficulty: "سهل", question_text: "رمز بداية الشهر (4 حروف، فلك، يوجد ألف).", answer: ["هلال"] },
            { type: "لغز", difficulty: "سهل", question_text: "سفينة الصحراء (3 حروف، حيوان، لا يوجد ألف).", answer: ["جمل"] },
            { type: "لغز", difficulty: "سهل", question_text: "سائل الحياة الأحمر (حرفان، جزء حيوي، لا يوجد ألف).", answer: ["دم"] },
            { type: "لغز", difficulty: "سهل", question_text: "فاكهة للكرمة (3 حروف، نبات، لا يوجد ألف).", answer: ["عنب"] },
            { type: "لغز", difficulty: "متوسط", question_text: "سلاح قديم (3 حروف، جماد، لا يوجد ألف).", answer: ["سيف"] },
            { type: "لغز", difficulty: "متوسط", question_text: "سر الحياة (3 حروف، سائل، يوجد ألف).", answer: ["ماء"] },
            { type: "لغز", difficulty: "متوسط", question_text: "معدن أصفر (3 حروف، معدن، لا يوجد ألف).", answer: ["ذهب"] },
            { type: "لغز", difficulty: "متوسط", question_text: "زمن السكون (3 حروف، وقت، لا يوجد ألف).", answer: ["ليل"] },
            { type: "لغز", difficulty: "متوسط", question_text: "مدخل الدار (3 حروف، جماد، يوجد ألف).", answer: ["باب"] },
            { type: "لغز", difficulty: "متوسط", question_text: "وتد الأرض (3 حروف، جماد، لا يوجد ألف).", answer: ["جبل"] },
            { type: "لغز", difficulty: "متوسط", question_text: "الامتناع عن الأكل (3 حروف، عبادة، لا يوجد ألف).", answer: ["صوم"] },
            { type: "لغز", difficulty: "صعب", question_text: "حيوان سريع (3 حروف، حيوان، لا يوجد ألف).", answer: ["فهد"] },
            { type: "لغز", difficulty: "صعب", question_text: "آلة النظر (3 حروف، عضو، لا يوجد ألف).", answer: ["عين"] },
            { type: "لغز", difficulty: "صعب", question_text: "عنصر الإحراق (3 حروف، عنصر، يوجد ألف).", answer: ["نار"] },
            { type: "لغز", difficulty: "صعب", question_text: "جهاز التواصل (4 حروف، آلة، يوجد ألف).", answer: ["هاتف"] },
            { type: "لغز", difficulty: "صعب", question_text: "طائر جارح (3 حروف، طائر، لا يوجد ألف).", answer: ["صقر"] },
            { type: "لغز", difficulty: "صعب", question_text: "عماد الدين (4 حروف، عبادة، يوجد ألف).", answer: ["صلاة"] },
            
            // --- (إصلاح 1) القسم الرابع: المعمّى (تم تصحيح الألغاز) ---
            { type: "معمّى", difficulty: "صعب", answer: ["الحسن"], question_text: "المرحلة 1 (لغز): جماد من 3 حروف لا ألف فيه (يدل على الجمال). المرحلة 2: أضف له 'ال' فصار اسم علم." },
            { type: "معمّى", difficulty: "صعب", answer: ["حرام"], question_text: "المرحلة 1 (لغز): حيوان للركوب صبور (4 حروف). المرحلة 2: لفّق حروفه لتحصل على صفة للممنوع شرعاً." }, // (م1: حمار، م2: حرام)
            { type: "معمّى", difficulty: "صعب", answer: ["سمسم"], question_text: "المرحلة 1 (أحجية): مادة تؤكل من مقطعين ('سم' + 'سم'). المرحلة 2: هو اسم لباب في قصة خيالية." }
        ];


        // 3. مولّد الألغاز المباشر
        function generatePuzzle(entry) {
            let puzzle = {
                question: "",
                answer: entry.answer, // هذه الآن مصفوفة
                rule: ""
            };
            
            switch (entry.type) {
                case "ملفق":
                    puzzle.question = `(ملفق): ${entry.question_text}`;
                    puzzle.rule = "الفصل الثاني: اللغز الملفق";
                    break;
                case "أحجية":
                    puzzle.question = `(أحجية): ${entry.question_text}`;
                    puzzle.rule = "الفصل الثالث: الأحجية";
                    break;
                case "لغز":
                    puzzle.question = `(لغز): ${entry.question_text}`;
                    puzzle.rule = "الفصل الرابع: اللغز (بالمعنى الأخص)";
                    break;
                case "معمّى":
                    puzzle.question = `(معمّى): ${entry.question_text}`;
                    puzzle.rule = "الفصل الخامس: المعمّى (مرحلتان)";
                    break;
            }
            return puzzle;
        }

        // 4. إدارة حالة اللعبة والنقاط
        let currentGameSettings = { difficulty: null, type: null };
        let currentPuzzleList = [];
        let currentPuzzle = null;
        let currentScore = 0;
        let lastGameScore = 0; 
        let highScore = 0;
        let currentStreak = 0;
        const CORRECT_DELAY = 1500;
        const SHOW_ANSWER_DELAY = 2000;

        // 5. جلب عناصر الواجهة
        const loadingScreenEl = document.getElementById('loading-screen');
        const puzzleRuleEl = document.getElementById('puzzle-rule');
        const puzzleQuestionEl = document.getElementById('puzzle-question');
        const puzzleScreenContentEl = document.getElementById('puzzle-screen-content');
        const answerInputEl = document.getElementById('answer-input');
        const checkButtonEl = document.getElementById('check-button');
        const startButtonEl = document.getElementById('start-button');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const puzzleContainerEl = document.getElementById('puzzle-container');
        const selectionContainerEl = document.getElementById('selection-container');
        const showAnswerButtonEl = document.getElementById('show-answer-button');
        const backToSettingsButtonEl = document.getElementById('back-to-settings-button');
        const howToPlayButtonEl = document.getElementById('how-to-play-button');
        const modalEl = document.getElementById('how-to-play-modal');
        const closeModalButtonEl = document.getElementById('close-modal-button');
        const scoreEl = document.querySelector('#stat-score strong');
        const highScoreEl = document.querySelector('#stat-highscore strong');
        const streakEl = document.querySelector('#stat-streak strong');
        const muteButtonEl = document.getElementById('mute-button');
        const muteTooltipEl = document.getElementById('mute-tooltip');
        const muteIconOn = document.querySelector('#mute-button .icon-on');
        const muteIconOff = document.querySelector('#mute-button .icon-off');
        const resetHighScoreButtonEl = document.getElementById('reset-highscore-button');
        const lastScoreContainerEl = document.getElementById('last-score-container');
        const lastScoreTextEl = document.getElementById('last-score-text');
        const shareButtonEl = document.getElementById('share-button');
        const shareFeedbackEl = document.getElementById('share-feedback');

        // 6. دوال اللعبة الأساسية
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function updateScoreboard() {
            scoreEl.textContent = currentScore;
            highScoreEl.textContent = highScore;
            streakEl.textContent = currentStreak;
        }

        function startGame() {
            playSound('start');
            currentGameSettings.difficulty = document.querySelector('input[name="difficulty"]:checked').value;
            // تم إلغاء اختيار النوع، سيتم اختيار "الكل" افتراضياً
            currentGameSettings.type = "الكل"; 

            let filteredBank = knowledgeBase;
            
            // ترشيح حسب المستوى فقط
            // ملاحظة: الكود لا يحتوي على خيار "الكل" للمستوى، لذا هذا الشرط سيعمل دائماً
            if (currentGameSettings.difficulty !== 'الكل') {
                 filteredBank = knowledgeBase.filter(p => p.difficulty === currentGameSettings.difficulty);
            }
            
            currentPuzzleList = [...filteredBank];
            shuffleArray(currentPuzzleList);

            currentScore = 0;
            currentStreak = 0;
            updateScoreboard();

            selectionContainerEl.classList.add('hidden');
            lastScoreContainerEl.classList.add('hidden'); // إخفاء نتيجة الجولة السابقة
            puzzleContainerEl.classList.remove('hidden');

            loadNextPuzzle();
        }

        function loadNextPuzzle() {
            resetUI();
            if (currentPuzzleList.length === 0) {
                puzzleQuestionEl.textContent = 'رائع! لقد أكملت جميع الألغاز في هذه الفئة.';
                answerInputEl.disabled = true;
                checkButtonEl.disabled = true;
                showAnswerButtonEl.disabled = true;
                puzzleScreenContentEl.classList.add('fade-in');
                return;
            }

            const nextEntry = currentPuzzleList.pop();
            currentPuzzle = generatePuzzle(nextEntry);

            puzzleQuestionEl.textContent = currentPuzzle.question;
            puzzleScreenContentEl.classList.remove('fade-in');
            void puzzleScreenContentEl.offsetWidth;
            puzzleScreenContentEl.classList.add('fade-in');
        }

        function goBackToSettings() {
            playSound('click');
            lastGameScore = currentScore; // حفظ النتيجة الأخيرة
            
            currentGameSettings = { difficulty: null, type: null };
            currentPuzzleList = [];
            currentPuzzle = null;

            puzzleContainerEl.classList.add('hidden');
            selectionContainerEl.classList.remove('hidden');
            
            // إظهار قسم النتيجة الأخيرة
            if (lastGameScore > 0) {
                lastScoreTextEl.textContent = `كانت نتيجتك الأخيرة: ${lastGameScore}`;
                lastScoreContainerEl.classList.remove('hidden');
                shareFeedbackEl.textContent = ''; // مسح رسالة النسخ
            }
            
            resetUI();
            answerInputEl.disabled = false;
        }

        function resetUI() {
            answerInputEl.value = '';
            answerInputEl.disabled = false;
            answerInputEl.classList.remove('game-input-correct', 'game-input-wrong', 'animate-shake');
            checkButtonEl.disabled = false;
            showAnswerButtonEl.disabled = false;
            feedbackMessageEl.textContent = '';
            feedbackMessageEl.className = 'mt-4 text-center h-8';
        }

        function checkAnswer() {
            if (!currentPuzzle) return;
            
            const normalizedUserAnswer = normalizeArabic(answerInputEl.value);
            if (normalizedUserAnswer === "") return;

            const correctAnswers = currentPuzzle.answer; 
            const normalizedCorrectAnswers = correctAnswers.map(normalizeArabic);

            if (normalizedCorrectAnswers.includes(normalizedUserAnswer)) {
                currentScore += 10;
                currentStreak++;
                if (currentScore > highScore) {
                    highScore = currentScore;
                    localStorage.setItem('puzzleHighScore', highScore);
                }
                updateScoreboard();
                playSound('correct');

                feedbackMessageEl.textContent = 'أحسنت! ... جارٍ تحميل اللغز التالي...';
                feedbackMessageEl.classList.add('feedback-correct');
                answerInputEl.classList.add('game-input-correct');
                
                answerInputEl.disabled = true;
                checkButtonEl.disabled = true;
                showAnswerButtonEl.disabled = true;
                
                setTimeout(loadNextPuzzle, CORRECT_DELAY);
            } else {
                currentStreak = 0;
                updateScoreboard();
                playSound('wrong');

                feedbackMessageEl.textContent = 'خطأ! حاول مرة أخرى.';
                feedbackMessageEl.classList.add('feedback-wrong');
                answerInputEl.classList.add('game-input-wrong');
                answerInputEl.classList.add('animate-shake');
                
                setTimeout(() => {
                    answerInputEl.classList.remove('animate-shake', 'game-input-wrong');
                    feedbackMessageEl.textContent = '';
                    feedbackMessageEl.classList.remove('feedback-wrong');
                }, 1000);
            }
        }
        
        function showAnswer() {
            if (!currentPuzzle) return;

            currentScore -= 5;
            if (currentScore < 0) currentScore = 0;
            currentStreak = 0;
            updateScoreboard();
            playSound('info');

            const displayAnswer = currentPuzzle.answer.join(' / ');

            feedbackMessageEl.textContent = `الجواب: ${displayAnswer} ... جارٍ التحميل...`;
            feedbackMessageEl.classList.add('feedback-info');
            answerInputEl.value = displayAnswer;

            checkButtonEl.disabled = true;
            answerInputEl.disabled = true;
            showAnswerButtonEl.disabled = true;

            setTimeout(loadNextPuzzle, SHOW_ANSWER_DELAY);
        }

        // دالة كتم الصوت
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('puzzleMuted', isMuted);
            updateMuteButton();
            if (!isMuted) {
                playSound('force-click'); // تشغيل صوت عند إلغاء الكتم
            }
        }

        // تحديث شكل زر كتم الصوت
        function updateMuteButton() {
            if (isMuted) {
                muteIconOn.style.display = 'none';
                muteIconOff.style.display = 'block';
                muteTooltipEl.textContent = 'تشغيل الصوت';
            } else {
                muteIconOn.style.display = 'block';
                muteIconOff.style.display = 'none';
                muteTooltipEl.textContent = 'كتم الصوت';
            }
        }

        // دالة مسح أعلى رصيد
        function resetHighScore() {
            playSound('wrong');
            highScore = 0;
            localStorage.setItem('puzzleHighScore', '0');
            updateScoreboard();
            if (currentScore === 0) { // تحديث لوحة النتائج إذا كان في شاشة اللعب
                scoreEl.textContent = 0;
            }
        }
        
        // دالة مشاركة النتيجة
        function shareScore() {
            playSound('click');
            const textToCopy = `لقد حصلت على ${lastGameScore} نقطة في تطبيق "نظام الألغاز"!`;
            
            // استخدام خدعة لنسخ النص
            const el = document.createElement('textarea');
            el.value = textToCopy;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                shareFeedbackEl.textContent = 'تم النسخ إلى الحافظة!';
            } catch (err) {
                shareFeedbackEl.textContent = 'فشل النسخ.';
            }
            document.body.removeChild(el);

            setTimeout(() => { shareFeedbackEl.textContent = ''; }, 2000);
        }

        // 7. ربط الأحداث
        document.addEventListener('DOMContentLoaded', () => {
            
            // ننتظر تحميل كل الموارد (الخطوط، إلخ)
            window.addEventListener('load', () => {
                // إعطاء 500ms إضافية لضمان استقرار الخطوط
                setTimeout(() => {
                    loadingScreenEl.classList.add('hidden');
                    document.body.classList.remove('is-loading');
                    
                    // إظهار نافذة كيفية اللعب للمستخدم الجديد فقط
                    const hasSeenRules = localStorage.getItem('puzzleRulesSeen');
                    if (!hasSeenRules) {
                        modalEl.classList.add('visible');
                        localStorage.setItem('puzzleRulesSeen', 'true');
                        playSound('click'); // محاولة تشغيل الصوت، سيتم تفعيل Tone.start()
                    }
                }, 500);
            });

            // تحميل الإعدادات المحفوظة
            highScore = parseInt(localStorage.getItem('puzzleHighScore') || '0', 10);
            isMuted = localStorage.getItem('puzzleMuted') === 'true';
            updateScoreboard();
            updateMuteButton();

            // ربط الأزرار
            startButtonEl.addEventListener('click', startGame);
            checkButtonEl.addEventListener('click', checkAnswer);
            showAnswerButtonEl.addEventListener('click', showAnswer);
            backToSettingsButtonEl.addEventListener('click', goBackToSettings);
            muteButtonEl.addEventListener('click', toggleMute);
            resetHighScoreButtonEl.addEventListener('click', resetHighScore);
            shareButtonEl.addEventListener('click', shareScore);
            
            answerInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !checkButtonEl.disabled) {
                    checkAnswer();
                }
            });

            // نافذة كيفية اللعب
            howToPlayButtonEl.addEventListener('click', () => {
                playSound('click');
                modalEl.classList.add('visible');
            });
            closeModalButtonEl.addEventListener('click', () => {
                playSound('click');
                modalEl.classList.remove('visible');
            });
            modalEl.addEventListener('click', (e) => {
                if (e.target === modalEl) {
                    playSound('click');
                    modalEl.classList.remove('visible');
                }
            });
        });

    </script>
</body>
</html>


